
# 集合结构

<cite>
**本文档引用的文件**  
- [session.js](file://cloudfunctions/seatArrangementFunctions/modules/session.js)
- [student.js](file://cloudfunctions/seatArrangementFunctions/modules/student.js)
- [wish.js](file://cloudfunctions/seatArrangementFunctions/modules/wish.js)
- [result.js](file://cloudfunctions/seatArrangementFunctions/modules/result.js)
- [auth.js](file://cloudfunctions/seatArrangementFunctions/modules/auth.js)
- [localdb.js](file://offline/storage/localdb.js)
- [initDatabase/index.js](file://cloudfunctions/initDatabase/index.js)
- [desktop/src/fileManager.js](file://desktop/src/fileManager.js)
</cite>

## 目录
1. [学生信息集合（students）](#学生信息集合students)
2. [排座会话集合（arrangement_sessions）](#排座会话集合arrangement_sessions)
3. [学生意愿集合（wishes）](#学生意愿集合wishes)
4. [座位分配集合（seat_assignments）](#座位分配集合seat_assignments)
5. [教室信息集合（classrooms）](#教室信息集合classrooms)
6. [全局关联键与命名规范](#全局关联键与命名规范)
7. [业务流程中的集合使用](#业务流程中的集合使用)
8. [JSON Schema 示例](#json-schema-示例)
9. [敏感字段脱敏策略](#敏感字段脱敏策略)

## 学生信息集合（students）

该集合存储学生的基本信息，是系统用户身份识别和班级管理的基础。

| 字段名称 | 类型 | 业务含义 | 约束条件 | 示例值 |
| :--- | :--- | :--- | :--- | :--- |
| `student_id` | 字符串 | 学生的唯一标识符 | 非空，唯一，由系统生成 | `stu_123456789` |
| `name` | 字符串 | 学生姓名 | 非空 | `张三` |
| `student_number` | 字符串 | 学号 | 非空，唯一，格式为9-12位数字 | `202400001` |
| `class_id` | 字符串 | 所属班级ID | 可为空，外键关联`classes`集合 | `class_2024A` |
| `wx_openid` | 字符串 | 微信开放ID | 可为空，用于微信登录绑定 | `o123456789` |
| `is_active` | 布尔值 | 学生状态（是否在籍） | 非空，默认为`true` | `true` |
| `special_needs` | 对象 | 特殊需求信息 | 可为空，包含视力、听力、身高等需求 | `{ vision_impaired: false, hearing_impaired: false, height_tall: false, other_requirements: "" }` |
| `personal_info` | 对象 | 个人资料（如头像、性别） | 可为空，用于用户界面展示 | `{ avatarUrl: "https://...", gender: 1 }` |
| `create_time` | 字符串 (ISO 8601) | 记录创建时间 | 非空，由系统自动填充 | `"2024-01-01T10:00:00Z"` |
| `update_time` | 字符串 (ISO 8601) | 记录更新时间 | 非空，由系统自动填充 | `"2024-01-01T10:00:00Z"` |

**集合来源**
- [student.js](file://cloudfunctions/seatArrangementFunctions/modules/student.js#L255-L302)
- [auth.js](file://cloudfunctions/seatArrangementFunctions/modules/auth.js#L30-L50)

## 排座会话集合（arrangement_sessions）

该集合代表一次具体的排座任务，是整个排座流程的核心控制单元，通过`session_id`与其他集合关联。

| 字段名称 | 类型 | 业务含义 | 约束条件 | 示例值 |
| :--- | :--- | :--- | :--- | :--- |
| `session_id` | 字符串 | 排座会话的唯一标识符 | 非空，唯一，由系统生成 | `session_987654321` |
| `admin_id` | 字符串 | 创建会话的管理员ID | 非空，外键关联`admins`集合 | `adm_001` |
| `classroom_id` | 字符串 | 使用的教室ID | 非空，外键关联`classrooms`集合 | `room_101` |
| `class_id` | 字符串 | 针对的班级ID | 非空，外键关联`classes`集合 | `class_2024A` |
| `title` | 字符串 | 会话标题 | 非空，默认为`"座位安排"` | `"2024年春季学期排座"` |
| `description` | 字符串 | 会话描述 | 可为空 | `"本学期第一次排座"` |
| `status` | 字符串 | 会话状态 | 非空，枚举值：`collecting`, `arranging`, `completed`, `published`, `cancelled` | `collecting` |
| `deadline` | 字符串 (ISO 8601) | 意愿提交截止时间 | 非空 | `"2024-01-05T23:59:59Z"` |
| `auto_start_arrangement` | 布尔值 | 是否自动开始排座 | 非空，默认为`false` | `true` |
| `auto_publish_result` | 布尔值 | 是否自动发布结果 | 非空，默认为`false` | `true` |
| `algorithm_params` | 对象 | 算法参数配置 | 非空，包含权重、迭代次数等 | `{ wish_weight: 0.4, teaching_weight: 0.3, ... }` |
| `notification_config` | 对象 | 通知配置 | 非空，包含发送时机 | `{ send_on_create: true, send_reminder: true, ... }` |
| `statistics` | 对象 | 统计信息 | 非空，包含学生总数、提交率等 | `{ total_students: 45, submitted_wishes: 30, completion_rate: 0.667 }` |
| `create_time` | 字符串 (ISO 8601) | 会话创建时间 | 非空，由系统自动填充 | `"2024-01-01T10:00:00Z"` |
| `update_time` | 字符串 (ISO 8601) | 会话更新时间 | 非空，由系统自动填充 | `"2024-01-01T10:00:00Z"` |

**集合来源**
- [session.js](file://cloudfunctions/seatArrangementFunctions/modules/session.js#L114-L153)
- [localdb.js](file://offline/storage/localdb.js#L55-L65)

## 学生意愿集合（wishes）

该集合存储学生在特定排座会话中提交的座位偏好，是排座算法的重要输入。

| 字段名称 | 类型 | 业务含义 | 约束条件 | 示例值 |
| :--- | :--- | :--- | :--- | :--- |
| `wish_id` | 字符串 | 意愿记录的唯一标识符 | 非空，唯一，由系统生成 | `wish_112233445` |
| `student_id` | 字符串 | 提交意愿的学生ID | 非空，外键关联`students`集合 | `stu_123456789` |
| `session_id` | 字符串 | 关联的排座会话ID | 非空，外键关联`arrangement_sessions`集合 | `session_987654321` |
| `version` | 整数 | 意愿版本号 | 非空，每次修改递增 | `1` |
| `status` | 字符串 | 意愿状态 | 非空，目前为`"submitted"` | `submitted` |
| `preferred_seats` | 对象数组 | 偏好座位列表 | 可为空，每个对象包含`seat_id` | `[{"seat_id": "seat_1_1"}, {"seat_id": "seat_1_2"}]` |
| `avoided_seats` | 对象数组 | 避免座位列表 | 可为空，每个对象包含`seat_id` | `[{"seat_id": "seat_6_8"}]` |
| `preferred_neighbors` | 对象数组 | 偏好邻座学生列表 | 可为空，每个对象包含`student_id` | `[{"student_id": "stu_987654321"}]` |
| `avoided_neighbors` | 对象数组 | 避免邻座学生列表 | 可为空，每个对象包含`student_id` | `[{"student_id": "stu_555555555"}]` |
| `special_requirements` | 字符串 | 特殊需求说明 | 可为空 | `"需要靠近讲台"` |
| `submit_time` | 字符串 (ISO 8601) | 提交时间 | 非空，由系统自动填充 | `"2024-01-02T14:30:00Z"` |
| `update_time` | 字符串 (ISO 8601) | 更新时间 | 非空，由系统自动填充 | `"2024-01-02T14:30:00Z"` |
| `modification_history` | 对象数组 | 修改历史记录 | 非空，记录每次修改的版本、时间和变更内容 | `[{"version": 1, "timestamp": "...", "changes": "初次提交"}]` |

**集合来源**
- [wish.js](file://cloudfunctions/seatArrangementFunctions/modules/wish.js#L41-L85)
- [localdb.js](file://offline/storage/localdb.js#L70-L85)

## 座位分配集合（seat_assignments）

该集合存储排座算法执行后的最终结果，即每个学生在特定会话中被分配到的座位。

| 字段名称 | 类型 | 业务含义 | 约束条件 | 示例值 |
| :--- | :--- | :--- | :--- | :--- |
| `assignment_id` | 字符串 | 分配记录的唯一标识符 | 非空，唯一，由系统生成 | `assign_123456789` |
| `session_id` | 字符串 | 关联的排座会话ID | 非空，外键关联`arrangement_sessions`集合 | `session_987654321` |
| `student_id` | 字符串 | 被分配座位的学生ID | 非空，外键关联`students`集合 | `stu_123456789` |
| `seat_id` | 字符串 | 分配的座位ID | 非空，外键关联`classrooms`集合中的座位 | `seat_3_4` |
| `satisfaction_score` | 数值 | 学生满意度评分 | 可为空，范围0-1，由算法计算 | `0.85` |
| `assignment_reasons` | 字符串数组 | 分配原因 | 可为空，如`["algorithm_optimization"]` | `["algorithm_optimization"]` |
| `manual_adjusted` | 布尔值 | 是否为手动调整 | 非空，默认为`false` | `false` |
| `assign_time` | 字符串 (ISO 8601) | 分配时间 | 非空，由系统自动填充 | `"2024-01-05T15:00:00Z"` |
| `update_time` | 字符串 (ISO 8601) | 更新时间 | 非空，由系统自动填充 | `"2024-01-05T15:00:00Z"` |
| `adjust_history` | 对象数组 | 手动调整历史 | 可为空，记录手动调整的详情 | `[{"from_seat": "seat_1_1", "to_seat": "seat_2_2", "reason": "管理员调整", "adjust_time": "..."}]` |

**集合来源**
- [result.js](file://cloudfunctions/seatArrangementFunctions/modules/result.js#L44-L76)
- [algorithm.js](file://cloudfunctions/seatArrangementFunctions/modules/algorithm.js#L422-L448)
- [localdb.js](file://offline/storage/localdb.js#L90-L98)

## 教室信息集合（classrooms）

该集合存储教室的物理布局信息，包括座位的排列和可用性。

| 字段名称 | 类型 | 业务含义 | 约束条件 | 示例值 |
| :--- | :--- | :--- | :--- | :--- |
| `classroom_id` | 字符串 | 教室的唯一标识符 | 非空，唯一，由系统生成 | `room_101` |
| `name` | 字符串 | 教室名称 | 非空 | `"第一教学楼101"` |
| `total_seats` | 整数 | 座位总数 | 非空 | `48` |
| `layout_config` | 对象 | 布局配置 | 非空，包含尺寸和座位详情 | `{ dimensions: { width: 8, height: 6 }, seats: [...] }` |
| `is_active` | 布尔值 | 教室状态（是否可用） | 非空，默认为`true` | `true` |
| `create_time` | 字符串 (ISO 8601) | 记录创建时间 | 非空，由系统自动填充 | `"2024-01-01T10:00:00Z"` |
| `update_time` | 字符串 (ISO 8601) | 记录更新时间 | 非空，由系统自动填充 | `"2024-01-01T10:00:00Z"` |

`layout_config` 对象结构：
- `dimensions`: 包含 `width` (列数) 和 `height` (行数)。
- `seats`: 座位对象数组，每个座位包含：
  - `seat_id`: 座位唯一ID。
  - `position`: 包含 `row` 和 `col` 的位置对象。
  - `is_available`: 布尔值，表示该座位是否可用。

**集合来源**
- [initDatabase/index.js](file://cloudfunctions/initDatabase/index.js#L89-L142)
- [desktop/src/fileManager.js](file://desktop/src/fileManager.js#L137-L186)
- [localdb.js](file://offline/storage/localdb.js#L45-L53)

## 全局关联键与命名规范

### `session_id` 的作用
`session_id` 是整个排座系统的**全局关联键**。它作为核心纽带，将一次排座任务中的所有数据关联起来：
- **关联意愿**：`wishes`集合通过`session_id`字段，将学生的偏好与特定的排座任务绑定。
- **关联结果**：`seat_assignments`集合通过`session_id`字段，确保分配结果与正确的排座会话对应。
- **关联会话**：`arrangement_sessions`集合自身以`session_id`为主键，存储该次任务的所有配置和状态。
- **关联统计**：`getStatistics`等函数通过`session_id`查询`wishes`和`students`集合，计算提交率等统计信息。

这种设计确保了数据的隔离性和一致性，使得系统可以同时管理多个班级、多个学期的排座任务而不会混淆。

### 命名规范
- **`student_id`**: 所有与学生相关的集合（如`students`, `wishes`, `seat_assignments`）都使用`student_id`作为学生标识字段。该ID以`stu_`为前缀，后接随机字符串或时间戳，确保全局唯一。
- **`seat_id`**: 所有与座位相关的集合（如`classrooms`, `wishes`, `seat_assignments`）都使用`seat_id`作为座位标识字段。该ID通常根据座位的行列位置生成，如`seat_3_4`表示第3排第4列。

**集合来源**
- [session.js](file://cloudfunctions/seatArrangementFunctions/modules/session.js#L0-L45)
- [wish.js](file://cloudfunctions/seatArrangementFunctions/modules/wish.js#L41-L85)
- [result.js](file://cloudfunctions/seatArrangementFunctions/modules/result.js#L44-L76)

## 业务流程中的集合使用

### `submitWish` 流程中的集合使用
当学生提交意愿时，`submitWish`函数会执行以下数据库操作：
1.  **读取 `arrangement_sessions` 集合**：验证`session_id`是否存在且处于`collecting`（收集意愿）状态，并检查截止时间。
2.  **读取 `classrooms` 集合**：获取教室的`layout_config`，以验证学生选择的偏好座位和避免座位是否在有效范围内。
3.  **读取 `wishes` 集合**：检查该学生是否已为当前会话提交过意愿，防止重复提交。
4.  **写入 `wishes` 集合**：如果验证通过，则将新的意愿数据（包含`student_id`, `session_id`, 偏好信息等）作为一条新记录插入到`wishes`集合中。
5.  **更新 `arrangement_sessions` 集合**：调用`updateSessionStatistics`函数，更新会话的统计信息（如`submitted_wishes`计数和`completion_rate`）。
6.  **写入 `system_logs` 集合**：记录`submit_wish`操作日志，用于审计和追踪。

**集合来源**
- [wish.js](file://cloudfunctions/seatArrangementFunctions/modules/wish.js#L41-L85)
- [wish.js](file://cloudfunctions/seatArrangementFunctions/modules/wish.js#L407-L453)

## JSON Schema 示例

以下是`wishes`集合的JSON Schema示例：

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Wish",
  "type": "object",
  "required": [
    "wish_id",
    "student_id",
    "session_id",
    "version",
    "status",
    "submit_time",
    "update_time"
  ],
  "properties": {
    "wish_id": {
      "type": "string",
      "description": "意愿记录的唯一标识符"
    },
    "student_id": {
      "type": "string",
      "description": "提交意愿的学生ID"
    },
    "session_id": {
      "type": "string",
      "description": "关联的排座会话ID"
    },
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "意愿版本号"
    },
    "status": {
      "type": "string",
      "enum": ["submitted"],
      "description": "意愿状态"
    },
    "preferred_seats": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "seat_id": { "type": "string" }
        },
        "required": ["seat_id"]
      },
      "maxItems": 5,
      "description": "偏好座位列表"
    },
    "avoided_seats": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "seat_id": { "type": "string" }
        },
        "required": ["seat_id"]
      },
      "maxItems": 5,
      "description": "避免座位列表"
    },
    "preferred_neighbors": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "student_id": { "type": "string" }
        },
        "required": ["student_id"]
      },
      "maxItems": 3,
      "description": "偏好邻座学生列表"
    },
    "avoided_neighbors": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "student_id": { "type": "string" }
        },
        "required": ["student_id"]
      },
      "maxItems": 3,
      "description": "避免邻座学生列表"
    },
    "special_requirements": {
      "type": "string",
      "maxLength": 200,
      "description": "特殊需求说明"
    },
    "submit_time": {
      "type": "string",
      "format": "date-time",
      "description": "提交时间"
    },
    "update_time": {
      "type": "string",
      "format": "date-time",
      "description": "更新时间"
    },
    "modification_history": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "version": { "type": "integer" },
          "timestamp": { "type