# 部署与配置

<cite>
**本文档引用的文件**
- [uploadCloudFunction.sh](file://uploadCloudFunction.sh)
- [project.config.json](file://project.config.json)
- [project.private.config.json](file://project.private.config.json)
- [envList.js](file://miniprogram/envList.js)
- [quickstartFunctions/index.js](file://cloudfunctions/quickstartFunctions/index.js)
- [seatArrangementFunctions/index.js](file://cloudfunctions/seatArrangementFunctions/index.js)
</cite>

## 目录
1. [云函数上传脚本使用](#云函数上传脚本使用)
2. [项目配置文件解析](#项目配置文件解析)
3. [多环境配置管理](#多环境配置管理)
4. [云函数本地调试与日志查看](#云函数本地调试与日志查看)
5. [部署前检查清单](#部署前检查清单)

## 云函数上传脚本使用

`uploadCloudFunction.sh` 脚本用于将云函数部署到微信云开发环境。该脚本通过调用云开发命令行工具实现自动化部署。

脚本执行命令：
```bash
${installPath} cloud functions deploy --e ${envId} --n quickstartFunctions --r --project ${projectPath}
```

参数说明：
- `--e ${envId}`：指定目标云环境ID，需要在执行脚本前设置环境变量
- `--n quickstartFunctions`：指定要部署的云函数名称
- `--r`：表示重新部署，覆盖现有函数
- `--project ${projectPath}`：指定项目根目录路径

使用步骤：
1. 确保已安装微信开发者工具和云开发CLI
2. 设置环境变量 `envId` 为目标环境ID
3. 在项目根目录执行脚本
4. 等待部署完成，查看部署日志确认结果

**Section sources**
- [uploadCloudFunction.sh](file://uploadCloudFunction.sh#L1)

## 项目配置文件解析

### project.config.json 关键字段

`project.config.json` 是项目的主要配置文件，包含项目基本信息和开发设置。

核心配置字段：
- `miniprogramRoot`: 小程序代码根目录，值为 "miniprogram/"
- `cloudfunctionRoot`: 云函数根目录，值为 "cloudfunctions/"
- `appid`: 小程序唯一标识，值为 "wxc2a4558299a599df"
- `projectname`: 项目名称，值为 "quickstart-wx-cloud"
- `libVersion`: 基础库版本，值为 "2.20.1"

### project.private.config.json 私有配置

`project.private.config.json` 是项目私有配置文件，其内容会覆盖 `project.config.json` 中的相同字段。

主要特点：
- 包含私有设置，不应提交到版本控制系统
- 项目改动优先同步到此文件
- 包含开发专用设置，如 `compileHotReLoad: true`
- 指定项目名称为 "AutoSeating"，与主配置文件不同
- 使用更新的基础库版本 "2.31.0"

**Section sources**
- [project.config.json](file://project.config.json#L1-L85)
- [project.private.config.json](file://project.private.config.json#L1-L25)

## 多环境配置管理

### envList.js 环境配置文件

`envList.js` 用于管理不同环境（开发/生产）的配置切换。

当前配置状态：
```javascript
const envList = [];
const isMac = false;
module.exports = {
  envList,
  isMac
};
```

配置说明：
- `envList`: 环境ID列表，当前为空数组，需要根据实际环境添加
- `isMac`: 标识操作系统类型，用于平台特定配置

环境管理建议：
1. 在 `envList` 数组中添加不同环境的云环境ID
2. 根据构建目标选择相应的环境ID
3. 开发环境使用测试环境ID，生产环境使用正式环境ID
4. 可结合构建脚本自动选择环境

**Section sources**
- [envList.js](file://miniprogram/envList.js#L1-L7)

## 云函数本地调试与日志查看

### 云函数结构

项目包含两个主要云函数：
- `quickstartFunctions`: 快速入门功能函数
- `seatArrangementFunctions`: 座位安排核心功能函数

### 本地调试方法

1. **使用微信开发者工具调试**：
   - 打开项目根目录
   - 在云函数目录右键选择"在本地模拟器中运行"
   - 使用调试器设置断点和查看变量

2. **调试技巧**：
   - 在代码中使用 `console.log()` 输出调试信息
   - 检查云函数入口函数 `exports.main` 的参数
   - 验证依赖模块的导入是否正确
   - 测试错误处理逻辑

3. **日志查看**：
   - 本地调试日志显示在开发者工具的控制台
   - 生产环境日志可在云开发控制台查看
   - 关键操作应记录详细日志，如用户登录、数据修改等
   - 使用统一的响应格式便于日志分析

### 调试注意事项

- 确保本地环境与云端环境一致
- 测试所有可能的错误路径
- 验证权限控制逻辑
- 检查数据库查询性能
- 测试并发访问情况

**Section sources**
- [quickstartFunctions/index.js](file://cloudfunctions/quickstartFunctions/index.js#L1-L156)
- [seatArrangementFunctions/index.js](file://cloudfunctions/seatArrangementFunctions/index.js#L1-L187)

## 部署前检查清单

### 权限设置

1. **云函数权限**：
   - 确认云函数的执行权限设置正确
   - 检查敏感操作的权限验证逻辑
   - 确保管理员功能仅限授权用户访问

2. **数据库权限**：
   - 验证数据库读写权限配置
   - 检查数据安全规则
   - 确认敏感数据的访问控制

### 数据库索引创建

1. **必要索引**：
   - 在 `students` 集合的 `wx_openid` 字段创建索引
   - 在 `arrangement_sessions` 集合的 `class_id` 和 `status` 字段创建复合索引
   - 在 `wishes` 集合的 `student_id` 和 `session_id` 字段创建索引
   - 在 `seat_assignments` 集合的 `session_id` 和 `student_id` 字段创建索引

2. **索引优化**：
   - 分析查询模式，创建适当的索引
   - 避免过度索引影响写入性能
   - 定期审查索引使用情况

### 安全规则配置

1. **数据安全规则**：
   - 配置数据库安全规则，限制未授权访问
   - 实现基于用户身份的数据访问控制
   - 设置合理的读写权限

2. **云函数安全**：
   - 验证所有云函数的输入参数
   - 实现适当的错误处理和异常捕获
   - 避免敏感信息泄露
   - 使用 JWT 令牌进行身份验证

3. **其他安全措施**：
   - 确保 JWT 密钥的安全存储
   - 验证用户输入，防止注入攻击
   - 实现适当的速率限制
   - 记录关键操作日志用于审计

**Section sources**
- [seatArrangementFunctions/modules/auth.js](file://cloudfunctions/seatArrangementFunctions/modules/auth.js#L1-L245)
- [seatArrangementFunctions/modules/student.js](file://cloudfunctions/seatArrangementFunctions/modules/student.js#L1-L322)
- [seatArrangementFunctions/modules/session.js](file://cloudfunctions/seatArrangementFunctions/modules/session.js#L1-L416)
- [seatArrangementFunctions/modules/wish.js](file://cloudfunctions/seatArrangementFunctions/modules/wish.js#L1-L454)
- [seatArrangementFunctions/modules/result.js](file://cloudfunctions/seatArrangementFunctions/modules/result.js#L1-L456)
- [seatArrangementFunctions/modules/algorithm.js](file://cloudfunctions/seatArrangementFunctions/modules/algorithm.js#L1-L509)
- [seatArrangementFunctions/modules/admin.js](file://cloudfunctions/seatArrangementFunctions/modules/admin.js#L1-L214)