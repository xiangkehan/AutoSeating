<!--pages/audit-logs/audit-logs.wxml-->
<view class="audit-logs-container">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">审计日志</text>
    <view class="header-actions">
      <button class="action-btn" bind:tap="toggleStatistics">
        <text class="icon">📊</text>
        统计
      </button>
      <button class="action-btn" bind:tap="toggleFilters">
        <text class="icon">🔍</text>
        筛选
      </button>
    </view>
  </view>

  <!-- 统计信息 -->
  <view class="statistics-panel" wx:if="{{showStatistics && statistics}}">
    <view class="statistics-header">
      <text class="section-title">最近7天统计</text>
    </view>
    
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-label">总操作数</text>
        <text class="stat-value">{{totalCount}}</text>
      </view>
      
      <view class="stat-item" wx:for="{{statistics.severity_stats}}" wx:key="_id">
        <text class="stat-label">{{item._id}}风险操作</text>
        <text class="stat-value">{{item.count}}</text>
      </view>
    </view>
  </view>

  <!-- 筛选面板 -->
  <view class="filter-panel" wx:if="{{showFilters}}">
    <view class="filter-header">
      <text class="section-title">筛选条件</text>
    </view>
    
    <view class="filter-grid">
      <view class="filter-item">
        <text class="filter-label">操作类型</text>
        <picker 
          range="{{operationOptions}}" 
          range-key="label" 
          value="{{filters.operation}}"
          data-field="operation"
          bind:change="onFilterChange"
        >
          <view class="picker-display">
            {{filters.operation ? (operationOptions.find(item => item.value === filters.operation)).label : '全部操作'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">风险级别</text>
        <picker 
          range="{{severityOptions}}" 
          range-key="label" 
          value="{{filters.severity}}"
          data-field="severity"
          bind:change="onFilterChange"
        >
          <view class="picker-display">
            {{filters.severity ? (severityOptions.find(item => item.value === filters.severity)).label : '全部级别'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">状态</text>
        <picker 
          range="{{statusOptions}}" 
          range-key="label" 
          value="{{filters.status}}"
          data-field="status"
          bind:change="onFilterChange"
        >
          <view class="picker-display">
            {{filters.status ? (statusOptions.find(item => item.value === filters.status)).label : '全部状态'}}
          </view>
        </picker>
      </view>
    </view>
    
    <view class="filter-actions">
      <button class="filter-btn secondary" bind:tap="clearFilters">清除</button>
      <button class="filter-btn primary" bind:tap="applyFilters">应用</button>
    </view>
  </view>

  <!-- 日志列表 -->
  <view class="logs-list">
    <view 
      class="log-item" 
      wx:for="{{logs}}" 
      wx:key="log_id"
      data-log="{{item}}"
      bind:tap="viewLogDetail"
    >
      <view class="log-header">
        <view class="log-operation">
          <text class="operation-text">{{getOperationText(item.operation)}}</text>
          <view class="severity-badge {{getSeverityClass(item.severity)}}">
            {{getSeverityText(item.severity)}}
          </view>
        </view>
        <text class="log-time">{{formatDate(item.timestamp)}}</text>
      </view>
      
      <view class="log-content">
        <view class="log-detail">
          <text class="detail-label">目标：</text>
          <text class="detail-value">{{item.target}}</text>
        </view>
        
        <view class="log-detail" wx:if="{{item.details}}">
          <text class="detail-label">详情：</text>
          <text class="detail-value">{{item.details}}</text>
        </view>
        
        <view class="log-detail">
          <text class="detail-label">用户：</text>
          <text class="detail-value">{{item.user_name}} ({{item.user_role}})</text>
        </view>
      </view>
      
      <view class="log-status">
        <view class="status-badge {{item.status === 'success' ? 'status-success' : 'status-error'}}">
          {{item.status === 'success' ? '成功' : '失败'}}
        </view>
      </view>
    </view>
    
    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore}}">
      <view class="loading" wx:if="{{loading}}">
        <text class="loading-text">加载中...</text>
      </view>
      <text class="load-tip" wx:else>上拉加载更多</text>
    </view>
    
    <!-- 没有更多数据 -->
    <view class="no-more" wx:if="{{!hasMore && logs.length > 0}}">
      <text class="no-more-text">没有更多数据了</text>
    </view>
    
    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{logs.length === 0 && !loading}}">
      <text class="empty-icon">📝</text>
      <text class="empty-text">暂无审计日志</text>
    </view>
  </view>
</view>